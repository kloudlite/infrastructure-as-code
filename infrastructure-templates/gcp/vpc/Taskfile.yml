version: 3

tasks:
  sync-variables:
    vars:
      bundlePath: "../../../terraform/modules/gcp/vpc"
      banner: |+
        /*
        DO NOT EDIT THIS FILE DIRECTLY. IT WILL BE OVERWRITTEN.
        If you need to change any variable, please edit the corresponding variables in the {{.bundlePath}} directory.
        If you want to create new variables, please create them in other files
        */
    cmds:
      - |+ #sh
        bundlePath="{{.bundlePath}}"
        bundleName=$(basename "$bundlePath")
        if [ -f "./variables-$bundleName.tf" ]; then
          chmod 600 "./variables-$bundleName.tf"
        fi

        [ -d "$bundlePath" ] || (echo "bundle path does not exist" && exit 1)
        
        cat > "./variables-$bundleName.tf" <<EOF
        {{.banner}}
        EOF
        
        cat $bundlePath/variables.tf >> ./variables-$bundleName.tf
        chmod 400 "./variables-$bundleName.tf"

  init:
    silent: true
    requires:
      vars:
        - backend_config
    cmds:
      - terraform init -reconfigure -lockfile=readonly -backend-config="{{.backend_config}}"

  validate:
    requires:
      vars:
        - tfvars_file
    cmds:
      - terraform validate

  create:plan:
    requires:
      vars:
        - backend_config
        - plan_file
        - tfvars_file
    cmds:
      - task: init
        vars:
          backend_config: "{{ .backend_config }}"
      - task: validate
      - |+
        terraform plan --var-file "{{.tfvars_file}}" --out "{{.plan_file}}"

  create:apply:
    requires:
      vars:
        - backend_config
        - plan_file
        - tfvars_file
    cmds:
      - task: init
        vars:
          backend_config: "{{ .backend_config }}"

      - task: create:plan
        vars:
          plan_file: "/tmp/new.tfplan"
          tfvars_file: "{{.tfvars_file}}"

      - |+
        if diff -q /tmp/new.tfplan "{{.plan_file}}"; then
          echo "plan is stale, please generate plan ({{.plan_file}}) again"
          exit 1
        fi

        terraform apply "{{.plan_file}}"

  destroy:plan:
    requires:
      vars:
        - backend_config
        - plan_file
        - tfvars_file
    cmds:
      - task: init
        vars:
          backend_config: "{{ .backend_config }}"
      - task: validate
      - terraform plan --var-file="{{.tfvars_file}}" --destroy --out "{{.plan_file}}"

  destroy:apply:
    requires:
      vars:
        - backend_config
        - plan_file
        - tfvars_file
    vars:
      tmp_plan:
        sh: mktemp
    cmds:
      - task: init
        vars:
          backend_config: "{{ .backend_config }}"

      - terraform apply "{{.plan_file}}"

      - task: create:plan
        vars:
          plan_file: "{{.tmp_plan }}"
          tfvars_file: "{{.tfvars_file}}"

      - |+
        if diff -q "{{.tmp_plan}}" "{{.plan_file}}"; then
          echo "plan is stale, please generate plan ({{.plan_file}}) again"
          exit 1
        fi

        terraform apply "{{.plan_file}}"
