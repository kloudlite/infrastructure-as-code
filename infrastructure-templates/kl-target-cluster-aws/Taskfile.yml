version: 3

tasks:
  sync-variables:
    vars:
      banner: |+
        /*
        DO NOT EDIT THIS FILE DIRECTLY. IT WILL BE OVERWRITTEN.
        If you need to change any variable, please edit the corresponding variables in the terraform/bundles directory.
        If you want to create new variables, please create them in other files
        */
    env:
      bundleNames: "kl-master-nodes-on-aws kl-worker-nodes-on-aws"
    cmds:
      - |+
        for bundleName in $bundleNames; do
          echo $bundleName
          bundlePath="../../terraform/bundles/$bundleName"
          if [ -f "./variables-$bundleName.tf" ]; then
            chmod 600 "./variables-$bundleName.tf"
          fi
          if [ -d "$bundlePath" ]; then
            cat > "./variables-$bundleName.tf" <<EOF
        {{.banner}}
        EOF
            cat "$bundlePath"/variables.tf >> "./variables-$bundleName.tf"
            patchFile="./variables-$bundleName.tf.diff.patch"
            [ -f "$patchFile" ] && patch ./variables-$bundleName.tf ./variables-$bundleName.tf.diff.patch
            chmod 400 "./variables-$bundleName.tf"
          fi
        done
