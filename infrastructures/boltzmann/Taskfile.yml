version: 3

vars:
  Varsfile: ".secrets/varfile.json"

dotenv:
  - .secrets/env

tasks:
  sync-from-template:
    vars:
      InfrastructureTemplate: ../../infrastructure-templates/kl-target-cluster-aws
    cmds:
      - |+
        chmod 600 ./*.tf
        cp {{.InfrastructureTemplate}}/*.tf ./
        chmod 400 ./*.tf

  init:
    cmds:
      - terraform init
    silent: true

  plan:
    dir: ./
    vars:
      PlanOutput: ".secrets/plan.out"
    cmds:
      - cat ./varfile.template.yml | envsubst | yq > {{.Varsfile}}
      - terraform plan --var-file "{{.Varsfile}}" --out "{{.PlanOutput}}" 
        -target="module.kl-worker-nodes-on-aws.module.aws-spot-nodepool[\"spot-np-2-gpu\"].module.spot-fleet-request[\"node-2\"].aws_launch_template.spot_template"
        # module.kl-worker-nodes-on-aws.module.aws-spot-nodepool["spot-np-2-gpu"].module.spot-fleet-request["node-1"].aws_launch_template.spot_template

  apply:
    dir: ./
    dotenv:
      - .secrets/env
    vars:
      PlanOutput: ".secrets/plan.out"
    cmds:
      - terraform apply "{{.PlanOutput}}"

  validate:
    dir: ./
    cmds:
      - terraform validate  -var-file={{.Varsfile}}

  destroy:
    dir: ./
    dotenv:
      - .secrets/env
    vars:
      PlanOutput: ".secrets/plan.destroy.out"
    cmds:
      - cat ./varfile.template.yml | envsubst | yq > {{.Varsfile}}
      - terraform plan --var-file={{.Varsfile}} --destroy --out "{{.PlanOutput}}" 
        -target="module.kl-worker-nodes-on-aws.module.aws-spot-nodepool[\"spot-np-2-gpu\"].module.spot-fleet-request[\"node-1\"].aws_launch_template.spot_template"
      - terraform apply "{{.PlanOutput}}"
